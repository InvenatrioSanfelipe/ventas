<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Ventas</title>
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
    }
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #222 80%, #444 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 20px;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.08);
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: 2px;
      font-weight: 700;
      font-size: 2rem;
    }
    .sidebar a {
      text-decoration: none;
      color: #fff;
      padding: 15px 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s, padding-left 0.3s;
      font-size: 1.1rem;
      border-left: 4px solid transparent;
    }
    .sidebar a:hover, .sidebar a.active {
      background: #333;
      border-left: 4px solid #00c3ff;
      padding-left: 30px;
    }
    .content {
      flex: 1;
      padding: 30px 40px 30px 40px;
      background: #f0f2f5;
      min-height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .section {
      display: none;
      animation: fadeIn 0.5s;
    }
    .section.active {
      display: block;
    }
    form {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      max-width: 500px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }
    form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #222;
    }
    form input, form select {
      width: 100%;
      padding: 10px;
      margin-bottom: 18px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      background: #f9f9f9;
      transition: border 0.2s;
    }
    form input:focus, form select:focus {
      border: 1.5px solid #00c3ff;
      outline: none;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      background: linear-gradient(90deg, #00c3ff 0%, #005bea 100%);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 2px 6px rgba(0,195,255,0.08);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      background: linear-gradient(90deg, #005bea 0%, #00c3ff 100%);
      box-shadow: 0 4px 12px rgba(0,195,255,0.15);
    }
    .categoria-box {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }
    .categoria-box input {
      flex: 1;
    }
    table {
      width: 100%;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      overflow: hidden;
      margin-bottom: 18px;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 1rem;
    }
    th {
      background: linear-gradient(90deg, #00c3ff 0%, #005bea 100%);
      color: #fff;
      font-weight: 700;
      letter-spacing: 1px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .total-box {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      padding: 18px 24px;
      position: absolute;
      right: 40px;
      bottom: 40px;
      min-width: 260px;
      z-index: 10;
      font-size: 1.1rem;
      color: #222;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .carrito-box {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      padding: 24px 28px;
      position: fixed;
      right: 60px;
      top: 80px;
      min-width: 320px;
      z-index: 100;
      font-size: 1.1rem;
      color: #222;
      display: none;
      flex-direction: column;
      gap: 12px;
      animation: fadeIn 0.4s;
    }
    .carrito-box.active {
      display: flex;
    }
    .carrito-header {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #005bea;
    }
    .carrito-list {
      max-height: 180px;
      overflow-y: auto;
      margin-bottom: 10px;
    }
    .carrito-list table {
      box-shadow: none;
      border-radius: 0;
      margin-bottom: 0;
    }
    .carrito-total {
      font-weight: 700;
      color: #00c3ff;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .carrito-cambio {
      font-weight: 600;
      color: #222;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    .carrito-close {
      position: absolute;
      top: 10px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: #888;
      cursor: pointer;
    }
    .carrito-close:hover {
      color: #d9534f;
    }
    .alert {
      position: fixed;
      bottom: 30px;
      right: 40px;
      padding: 16px 24px;
      border-radius: 10px;
      color: #fff;
      display: none;
      animation: fadeIn 0.5s;
      font-size: 1.1rem;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    }
    .alert.error {
      background: #d9534f;
    }
    .alert.success {
      background: #5cb85c;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 900px) {
      .content { padding: 15px; }
      .total-box, .carrito-box { right: 10px; bottom: 10px; left: 10px; min-width: unset; }
    }
  </style>
</head>
<body>
  <!-- Barra lateral -->
  <div class="sidebar">
    <h2>Ventas</h2>
    <a href="#" onclick="showSection('form-producto')">‚ûï Agregar Producto</a>
    <a href="#" onclick="showSection('pendientes')">‚è≥ Productos Pendientes</a>
    <a href="#" onclick="showSection('devoluciones')">üîÑ Devoluciones</a>
    <a href="#" onclick="showSection('venta')">üõí Venta</a>
    <a href="#" onclick="showSection('corte')">üìä Corte del D√≠a</a>
    <div style="flex:1"></div>
    <a href="#" onclick="mostrarCarritoVenta()" style="background:#005bea;color:#fff;font-weight:bold;justify-content:center;margin-bottom:18px;">
      üõí Carrito Venta (<span id="carritoVentaCantidad">0</span>)
    </a>
  </div>

  <!-- Contenido -->
  <div class="content">
    <h1 style="color:#005bea;font-weight:700;margin-bottom:18px;">Sistema de Ventas</h1>

    <!-- Secci√≥n agregar producto -->
    <div id="form-producto" class="section active">
      <h2>Agregar Producto</h2>
      <form onsubmit="guardarProducto(event)">
        <label for="codigo">C√≥digo</label>
        <input type="text" id="codigo" placeholder="Ej. 001" required>

        <label for="nombre">Nombre del producto</label>
        <input type="text" id="nombre" placeholder="Ej. Laptop Gamer" required>

        <label for="cantidad">Cantidad</label>
        <input type="number" id="cantidad" min="1" required>

        <label for="precio">Precio</label>
        <input type="number" id="precio" min="0" required>

        <label for="importe">Importe</label>
        <input type="number" id="importe" min="0" required placeholder="Ingresa el importe">

        <label for="categoria">Categor√≠a</label>
        <select id="categoria">
          <option value="">Seleccionar...</option>
          <option value="Electr√≥nica">Electr√≥nica</option>
          <option value="Accesorios">Accesorios</option>
        </select>

        <div class="categoria-box">
          <input type="text" id="nuevaCategoria" placeholder="Nueva categor√≠a">
          <button type="button" class="btn" onclick="agregarCategoria()">Agregar</button>
        </div>

        <button type="submit" class="btn">Guardar Producto</button>
      </form>
    </div>

    <!-- Pendientes -->
    <div id="pendientes" class="section">
      <h2>Productos Pendientes</h2>
      <button class="btn" onclick="exportarProductos()">Exportar Inventario</button>
      <input type="file" id="importFile" style="display:none" onchange="importarProductos(event)">
      <button class="btn" onclick="document.getElementById('importFile').click()">Importar Inventario</button>
      <table id="tablaPendientes">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Importe</th>
            <th>Categor√≠a</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <!-- Aqu√≠ van los productos -->
        </tbody>
      </table>
      <div class="total-box" id="totalBox">
        <div><b>Total productos:</b> <span id="totalProductos">0</span></div>
        <div><b>Total a vender:</b> $<span id="totalVender">0.00</span></div>
      </div>
    </div>

    <!-- Corte del D√≠a -->
    <div id="corte" class="section">
      <h2>Corte del D√≠a</h2>
      <table id="tablaCorte">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Productos vendidos</th>
            <th>Total venta</th>
          </tr>
        </thead>
        <tbody>
          <!-- Aqu√≠ van las ventas -->
        </tbody>
      </table>
      <div class="total-box" style="position:static;margin-top:20px;">
        <div><b>Total del d√≠a:</b> $<span id="totalCorte">0.00</span></div>
      </div>
    </div>

    <!-- Carrito de compras -->
    <div class="carrito-box" id="carritoBox">
      <button class="carrito-close" onclick="cerrarCarrito()">‚úñ</button>
      <div class="carrito-header">üõí Carrito de Compras</div>
      <div class="carrito-list" id="carritoLista"></div>
      <div class="carrito-total">Total a pagar: $<span id="carritoTotal">0.00</span></div>
      <div>
        <label for="montoRecibido">Monto recibido:</label>
        <input type="number" id="montoRecibido" min="0" style="width:120px;" oninput="calcularCambio()">
      </div>
      <div class="carrito-cambio">Cambio: $<span id="carritoCambio">0.00</span></div>
      <button class="btn" onclick="finalizarVenta()">Finalizar Venta</button>
    </div>

    <!-- Secci√≥n Venta -->
    <div id="venta" class="section">
      <h2>Venta</h2>
      <input type="text" id="busquedaVenta" placeholder="Buscar por nombre o c√≥digo..." style="width:100%;padding:12px;font-size:1.1rem;margin-bottom:18px;border-radius:8px;border:1.5px solid #00c3ff;" oninput="filtrarProductosVenta()">
      <div id="listaProductosVenta" style="margin-bottom:120px;"></div>
      <!-- Carrito de venta fijo abajo derecha -->
      <div class="total-box" id="carritoVentaBox" style="position:fixed;right:40px;bottom:40px;min-width:300px;z-index:200;display:none;">
        <div style="font-weight:bold;font-size:1.2rem;color:#005bea;">üõí Carrito de Venta</div>
        <div id="carritoVentaLista"></div>
        <div class="carrito-total">Total: $<span id="carritoVentaTotal">0.00</span></div>
        <div>
          <label for="montoRecibidoVenta">Monto recibido:</label>
          <input type="number" id="montoRecibidoVenta" min="0" style="width:120px;" oninput="calcularCambioVenta()">
        </div>
        <div class="carrito-cambio">Cambio: $<span id="carritoVentaCambio">0.00</span></div>
        <button class="btn" onclick="finalizarVentaDesdeVenta()">Finalizar Venta</button>
      </div>
    </div>

    <!-- Devoluciones -->
    <div id="devoluciones" class="section">
      <h2>Devoluciones</h2>
      <table id="tablaDevoluciones">
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Cantidad</th>
            <th>Precio</th>
            <th>Importe</th>
            <th>Categor√≠a</th>
          </tr>
        </thead>
        <tbody>
          <!-- Aqu√≠ van las devoluciones -->
        </tbody>
      </table>
    </div>

    <!-- Mensaje de advertencia -->
    <div id="alertBox" class="alert"></div>
  </div>

  <script>
    // Datos
    let productos = JSON.parse(localStorage.getItem("productos") || "[]");
    let devoluciones = JSON.parse(localStorage.getItem("devoluciones") || "[]");
    let carrito = [];
    let carritoVenta = [];
    let ventas = JSON.parse(localStorage.getItem("ventas") || "[]");

    function guardarEnLocal() {
      localStorage.setItem("productos", JSON.stringify(productos));
      localStorage.setItem("devoluciones", JSON.stringify(devoluciones));
      localStorage.setItem("ventas", JSON.stringify(ventas));
    }

    function showSection(id) {
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if (id === "pendientes") actualizarPendientes();
      if (id === "devoluciones") actualizarDevoluciones();
      if (id === "venta") {
        filtrarProductosVenta();
        ocultarCarritoVenta();
      }
      if (id === "corte") actualizarCorte();
    }

    // Agregar nueva categor√≠a
    function agregarCategoria() {
      const nuevaCat = document.getElementById("nuevaCategoria").value.trim();
      if (nuevaCat) {
        const select = document.getElementById("categoria");
        const option = document.createElement("option");
        option.value = nuevaCat;
        option.textContent = nuevaCat;
        select.appendChild(option);
        select.value = nuevaCat;
        document.getElementById("nuevaCategoria").value = "";
      }
    }

    // Mostrar productos pendientes en la tabla
    function actualizarPendientes() {
      const tbody = document.querySelector("#tablaPendientes tbody");
      tbody.innerHTML = "";
      let totalProductos = 0;
      let totalVender = 0;
      if (productos.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "No hay productos pendientes.";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
      } else {
        productos.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.codigo}</td>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>${p.precio}</td>
            <td>${p.importe}</td>
            <td>${p.categoria}</td>
            <td><button class="btn" onclick="devolverProducto(${idx})">Devolver</button></td>
          `;
          tbody.appendChild(tr);
          totalProductos += parseInt(p.cantidad) || 0;
          totalVender += parseFloat(p.importe) || 0;
        });
      }
      document.getElementById("totalProductos").textContent = totalProductos;
      document.getElementById("totalVender").textContent = totalVender.toFixed(2);
    }

    // Mostrar devoluciones
    function actualizarDevoluciones() {
      const tbody = document.querySelector("#tablaDevoluciones tbody");
      tbody.innerHTML = "";
      if (devoluciones.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "No hay devoluciones.";
        td.style.textAlign = "center";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      devoluciones.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${p.cantidad}</td>
          <td>${p.precio}</td>
          <td>${p.importe}</td>
          <td>${p.categoria}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Devolver producto
    function devolverProducto(idx) {
      const prod = productos[idx];
      devoluciones.push(prod);
      productos.splice(idx, 1);
      guardarEnLocal();
      actualizarPendientes();
      mostrarAlerta("üîÑ Producto devuelto al inventario", "success");
      actualizarDevoluciones();
    }

    // Guardar producto
    function guardarProducto(event) {
      event.preventDefault();

      const codigo = document.getElementById("codigo").value.trim();
      const nombre = document.getElementById("nombre").value.trim();
      const cantidad = document.getElementById("cantidad").value;
      const precio = document.getElementById("precio").value;
      const importe = document.getElementById("importe").value;
      const categoria = document.getElementById("categoria").value;

      // Verificar si ya existe
      const existe = productos.some(p => p.codigo === codigo || p.nombre.toLowerCase() === nombre.toLowerCase());

      if (existe) {
        mostrarAlerta("‚ö†Ô∏è El producto ya existe en el sistema", "error");
        return;
      }

      // Guardar producto
      productos.push({ codigo, nombre, cantidad, precio, importe, categoria });
      guardarEnLocal();
      mostrarAlerta("‚úÖ Producto agregado correctamente", "success");
      actualizarPendientes();

      // Resetear formulario
      event.target.reset();
    }

    // Exportar productos a archivo JSON
    function exportarProductos() {
      const dataStr = JSON.stringify(productos, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "inventario.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Importar productos desde archivo JSON
    function importarProductos(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            productos = data;
            guardarEnLocal();
            actualizarPendientes();
            mostrarAlerta("‚úÖ Inventario importado correctamente", "success");
          } else {
            mostrarAlerta("‚ö†Ô∏è Archivo no v√°lido", "error");
          }
        } catch {
          mostrarAlerta("‚ö†Ô∏è Archivo no v√°lido", "error");
        }
      };
      reader.readAsText(file);
    }

    // Carrito de compras
    function agregarAlCarrito(idx) {
      const prod = productos[idx];
      // Buscar si ya est√° en el carrito
      const existe = carrito.findIndex(p => p.codigo === prod.codigo);
      if (existe >= 0) {
        carrito[existe].cantidad = (parseInt(carrito[existe].cantidad) || 0) + (parseInt(prod.cantidad) || 1);
        carrito[existe].importe = (parseFloat(carrito[existe].importe) || 0) + (parseFloat(prod.importe) || 0);
      } else {
        carrito.push({ ...prod });
      }
      mostrarAlerta("üõí Producto agregado al carrito", "success");
      actualizarCarritoCantidad();
    }

    function actualizarCarritoCantidad() {
      document.getElementById("carritoCantidad").textContent = carrito.reduce((acc, p) => acc + (parseInt(p.cantidad) || 0), 0);
    }

    function mostrarCarrito() {
      const box = document.getElementById("carritoBox");
      box.classList.add("active");
      renderCarrito();
    }

    function cerrarCarrito() {
      document.getElementById("carritoBox").classList.remove("active");
      document.getElementById("montoRecibido").value = "";
      document.getElementById("carritoCambio").textContent = "0.00";
    }

    function renderCarrito() {
      const lista = document.getElementById("carritoLista");
      if (carrito.length === 0) {
        lista.innerHTML = "<div style='text-align:center;color:#888;'>No hay productos en el carrito.</div>";
      } else {
        let html = `<table><thead><tr>
          <th>Nombre</th><th>Cant.</th><th>Importe</th><th>Quitar</th>
        </tr></thead><tbody>`;
        carrito.forEach((p, idx) => {
          html += `<tr>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>$${parseFloat(p.importe).toFixed(2)}</td>
            <td><button class="btn" style="padding:4px 10px;font-size:0.9rem;" onclick="quitarDelCarrito(${idx})">‚úñ</button></td>
          </tr>`;
        });
        html += "</tbody></table>";
        lista.innerHTML = html;
      }
      document.getElementById("carritoTotal").textContent = carrito.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0).toFixed(2);
      calcularCambio();
    }

    function quitarDelCarrito(idx) {
      carrito.splice(idx, 1);
      renderCarrito();
      actualizarCarritoCantidad();
    }

    function calcularCambio() {
      const total = carrito.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0);
      const recibido = parseFloat(document.getElementById("montoRecibido").value) || 0;
      const cambio = recibido - total;
      document.getElementById("carritoCambio").textContent = cambio >= 0 ? cambio.toFixed(2) : "0.00";
    }

    function finalizarVenta() {
      if (carrito.length === 0) {
        mostrarAlerta("‚ö†Ô∏è El carrito est√° vac√≠o", "error");
        return;
      }
      const total = carrito.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0);
      const recibido = parseFloat(document.getElementById("montoRecibido").value) || 0;
      if (recibido < total) {
        mostrarAlerta("‚ö†Ô∏è El monto recibido es insuficiente", "error");
        return;
      }
      // Eliminar del inventario los productos vendidos
      carrito.forEach(c => {
        const idx = productos.findIndex(p => p.codigo === c.codigo);
        if (idx >= 0) productos.splice(idx, 1);
      });
      guardarEnLocal();
      actualizarPendientes();
      carrito = [];
      cerrarCarrito();
      mostrarAlerta("‚úÖ Venta realizada con √©xito", "success");
    }

    // --- Venta ---
    function filtrarProductosVenta() {
      const q = document.getElementById("busquedaVenta").value.trim().toLowerCase();
      const lista = document.getElementById("listaProductosVenta");
      let filtrados = productos.filter(p =>
        p.nombre.toLowerCase().includes(q) ||
        p.codigo.toLowerCase().includes(q)
      );
      if (filtrados.length === 0) {
        lista.innerHTML = "<div style='color:#888;text-align:center;'>No se encontraron productos.</div>";
        return;
      }
      let html = `<table><thead><tr>
        <th>C√≥digo</th><th>Nombre</th><th>Cantidad</th><th>Precio</th><th>Importe</th><th>Categor√≠a</th><th>Agregar</th>
      </tr></thead><tbody>`;
      filtrados.forEach((p, idx) => {
        html += `<tr>
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${p.cantidad}</td>
          <td>${p.precio}</td>
          <td>${p.importe}</td>
          <td>${p.categoria}</td>
          <td><button class="btn" onclick="agregarAlCarritoVenta('${p.codigo}')">Agregar</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      lista.innerHTML = html;
    }

    function agregarAlCarritoVenta(codigo) {
      const prod = productos.find(p => p.codigo === codigo);
      if (!prod) return;
      const existe = carritoVenta.findIndex(p => p.codigo === prod.codigo);
      if (existe >= 0) {
        // Solo suma 1 al carrito y suma el importe de 1 unidad
        carritoVenta[existe].cantidad = (parseInt(carritoVenta[existe].cantidad) || 0) + 1;
        // Calcula el importe unitario
        const importeUnitario = (parseFloat(prod.importe) || 0) / (parseInt(prod.cantidad) || 1);
        carritoVenta[existe].importe = (parseFloat(carritoVenta[existe].importe) || 0) + importeUnitario;
      } else {
        // Agrega solo 1 unidad al carrito
        const importeUnitario = (parseFloat(prod.importe) || 0) / (parseInt(prod.cantidad) || 1);
        carritoVenta.push({ ...prod, cantidad: 1, importe: importeUnitario });
      }
      mostrarAlerta("üõí Producto agregado al carrito de venta", "success");
      actualizarCarritoVenta();
    }

    function actualizarCarritoVenta() {
      document.getElementById("carritoVentaCantidad").textContent = carritoVenta.reduce((acc, p) => acc + (parseInt(p.cantidad) || 0), 0);
      renderCarritoVenta();
    }

    function mostrarCarritoVenta() {
      document.getElementById("carritoVentaBox").style.display = "flex";
      renderCarritoVenta();
    }

    function ocultarCarritoVenta() {
      document.getElementById("carritoVentaBox").style.display = "none";
    }

    function renderCarritoVenta() {
      const lista = document.getElementById("carritoVentaLista");
      if (carritoVenta.length === 0) {
        lista.innerHTML = "<div style='text-align:center;color:#888;'>No hay productos en el carrito.</div>";
      } else {
        let html = `<table><thead><tr>
          <th>Nombre</th><th>Cant.</th><th>Importe</th><th>Quitar</th>
        </tr></thead><tbody>`;
        carritoVenta.forEach((p, idx) => {
          html += `<tr>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>$${parseFloat(p.importe).toFixed(2)}</td>
            <td><button class="btn" style="padding:4px 10px;font-size:0.9rem;" onclick="quitarDelCarritoVenta(${idx})">‚úñ</button></td>
          </tr>`;
        });
        html += "</tbody></table>";
        lista.innerHTML = html;
      }
      document.getElementById("carritoVentaTotal").textContent = carritoVenta.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0).toFixed(2);
      calcularCambioVenta();
    }

    function quitarDelCarritoVenta(idx) {
      carritoVenta.splice(idx, 1);
      renderCarritoVenta();
      actualizarCarritoVenta();
    }

    function calcularCambioVenta() {
      const total = carritoVenta.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0);
      const recibido = parseFloat(document.getElementById("montoRecibidoVenta").value) || 0;
      const cambio = recibido - total;
      document.getElementById("carritoVentaCambio").textContent = cambio >= 0 ? cambio.toFixed(2) : "0.00";
    }

    function finalizarVentaDesdeVenta() {
      if (carritoVenta.length === 0) {
        mostrarAlerta("‚ö†Ô∏è El carrito est√° vac√≠o", "error");
        return;
      }
      const total = carritoVenta.reduce((acc, p) => acc + (parseFloat(p.importe) || 0), 0);
      const recibido = parseFloat(document.getElementById("montoRecibidoVenta").value) || 0;
      if (recibido < total) {
        mostrarAlerta("‚ö†Ô∏è El monto recibido es insuficiente", "error");
        return;
      }
      // Guardar venta
      ventas.push({
        fecha: new Date().toLocaleString(),
        productos: carritoVenta.map(p => ({ nombre: p.nombre, cantidad: p.cantidad })),
        total: total
      });
      // Eliminar del inventario los productos vendidos
      carritoVenta.forEach(c => {
        const idx = productos.findIndex(p => p.codigo === c.codigo);
        if (idx >= 0) productos.splice(idx, 1);
      });
      guardarEnLocal();
      actualizarPendientes();
      filtrarProductosVenta();
      carritoVenta = [];
      ocultarCarritoVenta();
      mostrarAlerta("‚úÖ Venta realizada con √©xito", "success");
    }

    // Mostrar alerta
    function mostrarAlerta(mensaje, tipo) {
      const alertBox = document.getElementById("alertBox");
      alertBox.textContent = mensaje;
      alertBox.className = "alert " + tipo;
      alertBox.style.display = "block";
      setTimeout(() => {
        alertBox.style.display = "none";
      }, 3000);
    }

    // Inicializar
    actualizarPendientes();
    actualizarDevoluciones();
  </script>
</body>
</html>
