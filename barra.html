<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #7C3AED;
            --accent: #10B981;
            --dark: #1F2937;
            --light: #F9FAFB;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .category-tag {
            background-color: var(--accent);
            transition: all 0.2s;
        }
        
        .category-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2) !important;
        }
        
        .btn-primary {
            background-color: var(--primary);
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #4338CA;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-item {
            transition: all 0.2s;
        }
        
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }
        
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid white;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="gradient-bg text-white w-64 flex flex-col flex-shrink-0">
        <div class="p-5 text-center border-b border-indigo-500">
            <div class="flex items-center justify-center space-x-2">
                <i class="fas fa-boxes text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">Gestión Productos</h1>
            </div>
            <p class="text-indigo-200 text-sm mt-1">v2.1</p>
        </div>
        
        <div class="flex-grow p-4 overflow-y-auto">
            <ul>
                <li class="mb-2">
                    <a href="#" class="sidebar-item active flex items-center p-3 rounded-lg" onclick="mostrarSeccion('agregar')">
                        <i class="fas fa-plus-circle mr-3"></i>
                        <span>Agregar Producto</span>
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" onclick="mostrarSeccion('pendientes')">
                        <i class="fas fa-hourglass-half mr-3"></i>
                        <span>Productos Pendientes</span>
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" onclick="mostrarSeccion('devoluciones')">
                        <i class="fas fa-exchange-alt mr-3"></i>
                        <span>Devoluciones</span>
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" onclick="mostrarSeccion('corte')">
                        <i class="fas fa-chart-line mr-3"></i>
                        <span>Corte del Día</span>
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" onclick="mostrarSeccion('venta')">
                        <i class="fas fa-cash-register mr-3"></i>
                        <span>Ventas</span>
                    </a>
                </li>
                <li class="mb-2">
                    <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" onclick="mostrarSeccion('importacion')">
                        <i class="fas fa-file-import mr-3"></i>
                        <span>Importar/Exportar</span>
                    </a>
                </li>
                <!-- Nueva opción para Administrar Productos -->
                <li class="mb-2">
                    <a href="#" class="sidebar-item" onclick="mostrarSeccion('adminProductos')">
                        <i class="fas fa-edit mr-2"></i> Administrar Productos
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="p-4 border-t border-indigo-500 text-center text-sm">
            <div class="flex items-center justify-center mb-2">
                <div class="w-8 h-8 rounded-full bg-indigo-200 flex items-center justify-center mr-2">
                    <i class="fas fa-user text-indigo-700"></i>
                </div>
                <span>Admin</span>
            </div>
            <button class="text-indigo-200 hover:text-white">Cerrar sesión</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto">
        <!-- Product Form -->
        <div id="agregar" class="seccion p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-cube mr-3 text-indigo-600"></i>
                    Nuevo Producto
                </h1>
                
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="gradient-bg p-4 text-white">
                        <h2 class="text-xl font-semibold">Información del Producto</h2>
                    </div>
                    
                    <div class="p-6">
                        <form id="productForm" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Left Column -->
                                <div>
                                    <!-- Codigo -->
                                    <div class="mb-6">
                                        <label for="codigo" class="block text-sm font-medium text-gray-700 mb-2">Código</label>
                                        <div class="flex">
                                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                                <i class="fas fa-barcode"></i>
                                            </span>
                                            <input type="text" id="codigo" name="codigo" class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="PROD-001">
                                        </div>
                                    </div>
                                    
                                    <!-- Descripción -->
                                    <div class="mb-6">
                                        <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                                        <textarea id="descripcion" name="descripcion" rows="3" class="block w-full border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Descripción detallada del producto"></textarea>
                                    </div>
                                    
                                    <!-- Categorías -->
                                    <div class="mb-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Categorías</label>
                                        <div class="flex space-x-2 mb-2">
                                            <div id="categoryContainer" class="flex flex-wrap gap-2">
                                                <!-- Categories will be added here -->
                                            </div>
                                        </div>
                                        <div class="flex">
                                            <input type="text" id="newCategory" class="flex-1 block w-full rounded-l-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nueva categoría">
                                            <button type="button" onclick="addCategory()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                <i class="fas fa-plus mr-1"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div>
                                    <!-- Piezas -->
                                    <div class="mb-6">
                                        <label for="piezas" class="block text-sm font-medium text-gray-700 mb-2">Piezas</label>
                                        <div class="flex">
                                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">
                                                <i class="fas fa-cubes"></i>
                                            </span>
                                            <input type="number" id="piezas" name="piezas" class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" value="1">
                                        </div>
                                    </div>
                                    
                                    <!-- Precios -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="mb-6">
                                            <label for="precioCliente" class="block text-sm font-medium text-gray-700 mb-2">Precio Venta</label>
                                            <div class="flex">
                                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">$</span>
                                                <input type="number" step="0.01" id="precioCliente" name="precioCliente" class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-6">
                                            <label for="precioCosto" class="block text-sm font-medium text-gray-700 mb-2">Precio que lo consiguió</label>
                                            <div class="flex">
                                                <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500">$</span>
                                                <input type="number" step="0.01" id="precioCosto" name="precioCosto" class="flex-1 block w-full rounded-none rounded-r-md border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Profit Indicator -->
                                    <div class="mb-6 bg-blue-50 p-3 rounded-lg border border-blue-100">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="text-sm text-blue-800">Margen estimado:</p>
                                                <p id="profitIndicator" class="text-lg font-semibold text-blue-600">$0.00</p>
                                            </div>
                                            <div class="text-blue-500">
                                                <i class="fas fa-chart-line text-2xl"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="reset" class="inline-flex items-center px-6 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="resetForm()">
                                    <i class="fas fa-trash-alt mr-2"></i> Limpiar
                                </button>
                                <button type="submit" class="btn-primary inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <i class="fas fa-save mr-2"></i> Guardar Producto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Product List -->
                <div class="mt-8 bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="gradient-bg p-4 text-white">
                        <h2 class="text-xl font-semibold">Productos Registrados</h2>
                    </div>
                    
                    <div class="p-4 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Costo</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Venta</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productList" class="bg-white divide-y divide-gray-200">
                                <!-- Product rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Other Sections (Hidden by default) -->
        <div id="pendientes" class="seccion hidden p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Productos Pendientes</h1>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="gradient-bg p-4 text-white">
                        <h2 class="text-xl font-semibold">Productos con piezas en cero</h2>
                    </div>
                    <div class="p-4 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categorías</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Costo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Venta</th>
                                </tr>
                            </thead>
                            <tbody id="pendientesList" class="bg-white divide-y divide-gray-200">
                                <!-- Productos pendientes aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="devoluciones" class="seccion hidden p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Devoluciones</h1>
                <input id="busquedaDevolucion" type="text" placeholder="Buscar producto por código o descripción..." class="w-full mb-4 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Piezas</th>
                            <th class="px-4 py-2"></th>
                        </tr>
                    </thead>
                    <tbody id="devolucionListaProductos" class="bg-white divide-y divide-gray-200">
                        <!-- Resultados de búsqueda aquí -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="corte" class="seccion hidden p-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Corte Diario</h1>
                <div class="mb-4">
                    <label for="fechaCorte" class="block text-sm font-medium text-gray-700">Selecciona la fecha:</label>
                    <input type="date" id="fechaCorte" class="mt-1 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-400">
                </div>
                <div id="corteResultados"></div>
            </div>
        </div>
        
        <div id="venta" class="seccion hidden p-8">
            <div class="max-w-5xl mx-auto flex gap-8">
                <!-- Buscador y lista de productos -->
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Ventas</h1>
                    <input id="busquedaVenta" type="text" placeholder="Buscar producto por código o nombre exacto..." class="w-full mb-4 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    <table class="min-w-full divide-y divide-gray-200 mb-4">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Precio Venta</th>
                                <th class="px-4 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="ventaListaProductos" class="bg-white divide-y divide-gray-200">
                            <!-- Productos para vender aquí -->
                        </tbody>
                    </table>
                </div>
                <!-- Panel de venta -->
                <div class="w-80 bg-white rounded-xl shadow-lg p-6 flex flex-col relative h-[600px]">
                    <div class="mb-2">
                        <span class="text-sm text-gray-500">Tickets hoy: </span>
                        <span id="contadorTickets" class="font-bold text-indigo-600">0</span>
                    </div>
                    <h2 class="text-xl font-semibold mb-4">Ticket de Venta</h2>
                    <div id="ventaTicket" class="flex-1 overflow-y-auto mb-4 border-b pb-4">
                        <!-- Productos seleccionados aquí -->
                    </div>
                    <!-- Total fijo en la parte inferior -->
                    <div class="absolute bottom-16 left-0 w-full px-6">
                        <div class="flex justify-between text-lg font-bold py-2">
                            <span>Total:</span>
                            <span id="ventaTotal">$0.00</span>
                        </div>
                        <button class="btn-primary w-full mt-2 py-2 rounded text-white font-semibold" onclick="abrirModalCobro()">Cobrar</button>
                    </div>
                    <!-- Fecha y hora en la parte más baja -->
                    <div class="absolute bottom-2 left-0 w-full px-6 text-xs text-gray-500 flex justify-between">
                        <span id="ticketFecha"></span>
                        <span id="ticketHora"></span>
                    </div>
                </div>
            </div>
            <!-- Modal de cobro -->
            <div id="modalCobro" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg p-8 shadow-lg w-96">
                    <h2 class="text-xl font-bold mb-4">Cobrar Venta</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Total a cobrar:</label>
                        <div class="text-2xl font-bold mb-2" id="modalTotal"></div>
                        <label class="block text-sm font-medium mb-1">Monto recibido:</label>
                        <input type="number" id="montoRecibido" class="w-full px-3 py-2 border rounded mb-2" min="0" step="0.01">
                        <div id="cambioMsg" class="text-green-600 font-semibold"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="cerrarModalCobro()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cerrar</button>
                        <button onclick="finalizarVentaConCobro()" class="btn-primary px-4 py-2 rounded text-white font-semibold">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Nueva sección de Importación/Exportación -->
        <div id="importacion" class="seccion hidden p-8">
            <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Importar / Exportar Inventario</h1>
                <div class="flex flex-col gap-4">
                    <button class="btn-primary py-2 rounded text-white font-semibold" onclick="exportarDatos()">Exportar Inventario y Ventas</button>
                    <input type="file" id="archivoImportar" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    <button class="btn-primary py-2 rounded text-white font-semibold" onclick="importarDatos()">Importar Inventario y Ventas</button>
                </div>
                <div id="importExportMsg" class="mt-4 text-sm"></div>
            </div>
        </div>

        <!-- Nueva sección de Administrar Productos -->
        <div id="adminProductos" class="seccion hidden p-8">
            <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Administrar Productos</h1>
                <input id="busquedaAdmin" type="text" placeholder="Buscar producto por código o nombre exacto..." class="w-full mb-4 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-indigo-400">
                <div id="adminProductoForm"></div>
            </div>
        </div>

        <!-- Modal para editar producto -->
        <div id="modalEditarProducto" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-8 shadow-lg w-full max-w-lg">
                <h2 class="text-xl font-bold mb-4">Editar Producto</h2>
                <form id="formEditarProducto" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium">Código</label>
                        <input type="text" id="editCodigo" disabled class="w-full px-3 py-2 border rounded bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Descripción</label>
                        <input type="text" id="editDescripcion" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Precio Costo</label>
                        <input type="number" id="editPrecioCosto" min="0" step="0.01" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Precio Venta</label>
                        <input type="number" id="editPrecioCliente" min="0" step="0.01" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Piezas</label>
                        <input type="number" id="editPiezas" min="0" step="1" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="cerrarModalEditarProducto()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded text-white font-semibold">Actualizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="waitOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 shadow-lg flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-indigo-600 text-2xl"></i>
        <span class="text-lg font-semibold text-gray-700">Por favor, espere...</span>
      </div>
    </div>

    <script>
        // Global variables
        let categories = [];
        let selectedCategories = [];
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let ventaSeleccionados = [];
        let ventas = JSON.parse(localStorage.getItem('ventas')) || [];
        let totalVentaActual = 0;

        // Ejecuta esto una vez para actualizar productos existentes
        products.forEach(p => {
            if (typeof p.stockOriginal === 'undefined') {
                p.stockOriginal = p.piezas;
            }
        });
        localStorage.setItem('products', JSON.stringify(products));

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            renderCategoryTags();
            renderProductList();
            
            // Load categories from localStorage
            const savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
                renderCategoryTags();
            }
            
            // Price change listeners
            document.getElementById('precioCliente').addEventListener('change', calculateProfit);
            document.getElementById('precioCosto').addEventListener('change', calculateProfit);
        });
        
        // Show/hide sections
        function mostrarSeccion(seccionId) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            
            document.getElementById(seccionId).classList.remove('hidden');
            event.currentTarget.classList.add('active');
        }
        
        // Add new category
        function addCategory() {
            const input = document.getElementById('newCategory');
            const categoryName = input.value.trim();
            
            if (categoryName && !categories.includes(categoryName)) {
                categories.push(categoryName);
                localStorage.setItem('categories', JSON.stringify(categories));
                renderCategoryTags();
                input.value = '';
            }
        }
        
        // Toggle category selection
        function toggleCategory(category) {
            const index = selectedCategories.indexOf(category);
            if (index === -1) {
                selectedCategories.push(category);
            } else {
                selectedCategories.splice(index, 1);
            }
            
            renderCategoryTags();
        }
        
        // Render category tags
        function renderCategoryTags() {
            const container = document.getElementById('categoryContainer');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const isSelected = selectedCategories.includes(category);
                const tag = document.createElement('div');
                tag.className = `category-tag px-3 py-1 rounded-full text-xs cursor-pointer flex items-center ${isSelected ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-800'}`;
                tag.innerHTML = `
                    <span>${category}</span>
                    <span class="ml-1 text-xs opacity-70">${isSelected ? '✓' : '+'}</span>
                `;
                tag.onclick = () => toggleCategory(category);
                container.appendChild(tag);
            });
        }
        
        // Calculate profit
        function calculateProfit() {
            const precioCliente = parseFloat(document.getElementById('precioCliente').value) || 0;
            const precioCosto = parseFloat(document.getElementById('precioCosto').value) || 0;
            const piezas = parseFloat(document.getElementById('piezas').value) || 0;
            const profit = (precioCliente - precioCosto) * piezas;
            
            document.getElementById('profitIndicator').textContent = '$' + profit.toFixed(2);
        }
        
        // Render product list
        function renderProductList() {
            const tbody = document.getElementById('productList');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const profit = (product.precioCliente - product.precioCosto) * product.piezas;
                const profitClass = profit >= 0 ? 'text-green-600' : 'text-red-600';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${product.codigo}</td>
                    <td class="px-6 py-4">${product.descripcion}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${product.precioCosto.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${product.precioCliente.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="deleteProduct('${product.codigo}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Renderiza la lista de productos pendientes (piezas == 0)
        function renderPendientesList() {
            const tbody = document.getElementById('pendientesList');
            tbody.innerHTML = '';
            const pendientes = products.filter(p => p.piezas === 0);

            if (pendientes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay productos pendientes.</td></tr>`;
                return;
            }

            pendientes.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${product.codigo}</td>
                    <td class="px-6 py-4">${product.descripcion}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${product.categorias.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${product.precioCosto.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${product.precioCliente.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Cuando se muestre la sección de pendientes, renderiza la lista
        document.querySelector('a[onclick*="pendientes"]').addEventListener('click', renderPendientesList);
        
        // Delete product
        function deleteProduct(code) {
            products = products.filter(p => p.codigo !== code);
            localStorage.setItem('products', JSON.stringify(products));
            renderProductList();
        }
        
        // Reset form
        function resetForm() {
            selectedCategories = [];
            renderCategoryTags();
            document.getElementById('profitIndicator').textContent = '$0.00';
        }
        
        // Form submission
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate required fields
            const codigo = document.getElementById('codigo').value;
            const descripcion = document.getElementById('descripcion').value;
            
            if (!codigo) {
                alert('Por favor ingresa un código');
                return;
            }
            
            if (!descripcion) {
                alert('Por favor ingresa una descripción');
                return;
            }
            
            if (selectedCategories.length === 0) {
                alert('Por favor selecciona al menos una categoría');
                return;
            }
            
            // Create product object
            const product = {
                codigo: codigo,
                descripcion: descripcion,
                categorias: [...selectedCategories],
                precioCosto: parseFloat(document.getElementById('precioCosto').value) || 0,
                precioCliente: parseFloat(document.getElementById('precioCliente').value) || 0,
                piezas: parseFloat(document.getElementById('piezas').value) || 0,
                stockOriginal: parseFloat(document.getElementById('piezas').value) || 0, // <--- agrega esto
                fechaRegistro: new Date().toISOString()
            };
            
            // Add to products array
            products.push(product);
            
            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Show success message and reset form
            alert('Producto guardado exitosamente');
            this.reset();
            resetForm();
            renderProductList();
        });
        
        // Calculate profit when prices change
        document.getElementById('precioCliente').addEventListener('input', calculateProfit);
        document.getElementById('precioCosto').addEventListener('input', calculateProfit);
        document.getElementById('piezas').addEventListener('input', calculateProfit);

        // Muestra el overlay de espera
        function mostrarEspera() {
          document.getElementById('waitOverlay').classList.remove('hidden');
        }
        // Oculta el overlay de espera
        function ocultarEspera() {
          document.getElementById('waitOverlay').classList.add('hidden');
        }

        // Ejemplo de uso:
        // mostrarEspera();
        // setTimeout(ocultarEspera, 2000); // Oculta después de 2 segundos

        // Renderiza la lista de productos para venta (coincidencia exacta)
        function renderVentaProductos(filtro = '') {
            const tbody = document.getElementById('ventaListaProductos');
            tbody.innerHTML = '';
            const filtroTrim = filtro.trim().toLowerCase();

            let filtrados = [];
            if (filtroTrim) {
                filtrados = products.filter(p =>
                    p.codigo.toLowerCase() === filtroTrim ||
                    p.descripcion.toLowerCase() === filtroTrim
                );
            } else {
                filtrados = products;
            }

            if (filtrados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No se encontraron productos.</td></tr>`;
                return;
            }

            filtrados.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-2">${product.codigo}</td>
                    <td class="px-4 py-2">${product.descripcion}</td>
                    <td class="px-4 py-2">$${product.precioCliente.toFixed(2)}</td>
                    <td class="px-4 py-2">
                        <button class="text-indigo-600 hover:underline" onclick="agregarAVenta('${product.codigo}')">Agregar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Agrega producto al ticket de venta
        function agregarAVenta(codigo) {
            const prod = products.find(p => p.codigo === codigo);
            if (!prod) return;

            let item = ventaSeleccionados.find(i => i.codigo === codigo);
            if (item) {
                if (item.cantidad < prod.piezas) {
                    item.cantidad++;
                } else {
                    alert('No hay más piezas disponibles.');
                }
            } else {
                if (prod.piezas > 0) {
                    ventaSeleccionados.push({
                        codigo: prod.codigo,
                        descripcion: prod.descripcion,
                        precio: prod.precioCliente,
                        cantidad: 1,
                        max: prod.piezas
                    });
                } else {
                    alert('Producto sin existencias.');
                }
            }
            renderVentaTicket();
        }

        // Renderiza el ticket de venta y actualiza fecha/hora y total
        function renderVentaTicket() {
            const cont = document.getElementById('ventaTicket');
            cont.innerHTML = '';
            let total = 0;

            if (ventaSeleccionados.length === 0) {
                cont.innerHTML = `<div class="text-gray-400 text-center">No hay productos en el ticket.</div>`;
            } else {
                ventaSeleccionados.forEach(item => {
                    total += item.precio * item.cantidad;
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center mb-2";
                    div.innerHTML = `
                        <div>
                            <span class="font-semibold">${item.descripcion}</span>
                            <span class="text-xs text-gray-500 ml-2">x${item.cantidad}</span>
                        </div>
                        <div>
                            <span>$${(item.precio * item.cantidad).toFixed(2)}</span>
                            <button class="ml-2 text-red-500 hover:underline" onclick="quitarDeVenta('${item.codigo}')">Quitar</button>
                        </div>
                    `;
                    cont.appendChild(div);
                });
            }
            totalVentaActual = total;
            document.getElementById('ventaTotal').textContent = '$' + total.toFixed(2);

            // Fecha y hora actual
            const now = new Date();
            document.getElementById('ticketFecha').textContent = now.toLocaleDateString();
            document.getElementById('ticketHora').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Quita un producto del ticket
        function quitarDeVenta(codigo) {
            ventaSeleccionados = ventaSeleccionados.filter(i => i.codigo !== codigo);
            renderVentaTicket();
        }

        // Contador de tickets del día
        function renderContadorTickets() {
            const ventas = JSON.parse(localStorage.getItem('ventas')) || [];
            const hoy = new Date().toISOString().slice(0, 10);
            const ticketsHoy = ventas.filter(v => v.fecha === hoy).length;
            document.getElementById('contadorTickets').textContent = ticketsHoy;
        }

        // Evento para buscar productos
        document.getElementById('busquedaVenta').addEventListener('input', function() {
            renderVentaProductos(this.value);
        });

        // Renderiza productos y ticket al entrar a la sección de venta
        document.querySelector('a[onclick*="venta"]').addEventListener('click', function() {
            renderVentaProductos();
            renderVentaTicket();
            renderContadorTickets();
        });

        // Modal de cobro
        function abrirModalCobro() {
            if (ventaSeleccionados.length === 0) {
                alert('No hay productos en el ticket.');
                return;
            }
            document.getElementById('modalTotal').textContent = '$' + totalVentaActual.toFixed(2);
            document.getElementById('montoRecibido').value = '';
            document.getElementById('cambioMsg').textContent = '';
            document.getElementById('modalCobro').classList.remove('hidden');
            document.getElementById('montoRecibido').focus();
        }

        function cerrarModalCobro() {
            document.getElementById('modalCobro').classList.add('hidden');
        }

        // Finaliza la venta con cobro y calcula cambio
        function finalizarVentaConCobro() {
            const monto = parseFloat(document.getElementById('montoRecibido').value);
            if (isNaN(monto) || monto < totalVentaActual) {
                document.getElementById('cambioMsg').textContent = 'Monto insuficiente.';
                return;
            }
            const cambio = monto - totalVentaActual;
            document.getElementById('cambioMsg').textContent = 'Cambio: $' + cambio.toFixed(2);

            // Guarda la venta
            let productosVendidos = [];
            ventaSeleccionados.forEach(item => {
                const prod = products.find(p => p.codigo === item.codigo);
                if (prod) {
                    productosVendidos.push({
                        codigo: prod.codigo,
                        descripcion: prod.descripcion,
                        precio: prod.precioCliente,
                        cantidad: item.cantidad
                    });
                    // Actualiza el stock del producto
                    prod.piezas -= item.cantidad;
                }   
            });

            // Guarda en localStorage
            ventas.push({
                fecha: new Date().toISOString().slice(0, 10),
                productos: productosVendidos,
                total: totalVentaActual
            });
            localStorage.setItem('ventas', JSON.stringify(ventas));
            localStorage.setItem('products', JSON.stringify(products));

            // Resetea el ticket de venta
            ventaSeleccionados = [];
            renderVentaTicket();
            renderContadorTickets();
            cerrarModalCobro();
            alert('Venta registrada exitosamente');
        }

        // Exportar datos a JSON
        function exportarDatos() {
            const data = {
                products: JSON.parse(localStorage.getItem('products')) || [],
                ventas: JSON.parse(localStorage.getItem('ventas')) || []
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'datos_inventario_ventas.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Importar datos desde JSON
        function importarDatos() {
            const fileInput = document.getElementById('archivoImportar');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Por favor selecciona un archivo para importar');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Importa productos
                    if (Array.isArray(data.products)) {
                        data.products.forEach(p => {
                            // Verifica si el producto ya existe
                            const existingProduct = products.find(prod => prod.codigo === p.codigo);
                            if (!existingProduct) {
                                products.push(p);
                            }
                        });
                    }
                    
                    // Importa ventas
                    if (Array.isArray(data.ventas)) {
                        data.ventas.forEach(v => {
                            ventas.push(v);
                        });
                    }
                    
                    // Guarda en localStorage
                    localStorage.setItem('products', JSON.stringify(products));
                    localStorage.setItem('ventas', JSON.stringify(ventas));
                    
                    alert('Datos importados exitosamente');
                } catch (error) {
                    alert('Error al importar datos: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Al buscar en administrar productos
        document.getElementById('busquedaAdmin').addEventListener('input', function() {
            const filtro = this.value.trim().toLowerCase();
            const productosFiltrados = products.filter(p =>
                p.codigo.toLowerCase().includes(filtro) ||
                p.descripcion.toLowerCase().includes(filtro)
            );
            renderAdminProductList(productosFiltrados);
        });

        // Renderiza la lista de productos en la sección de administrar productos
        function renderAdminProductList(lista) {
            const contenedor = document.getElementById('adminProductoForm');
            contenedor.innerHTML = '';

            if (lista.length === 0) {
                contenedor.innerHTML = `<p class="text-center text-gray-500 py-4">No se encontraron productos.</p>`;
                return;
            }

            lista.forEach(product => {
                const div = document.createElement('div');
                div.className = "bg-white rounded-lg shadow-md p-4 mb-4";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h3 class="text-lg font-semibold">${product.descripcion}</h3>
                            <p class="text-sm text-gray-500">Código: ${product.codigo}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold">$${product.precioCliente.toFixed(2)}</p>
                            <p class="text-sm text-gray-500">Costo: $${product.precioCosto.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${product.categorias.map(cat => `<span class="bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full px-3 py-1">${cat}</span>`).join('')}
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button class="btn-primary px-4 py-2 rounded text-white font-semibold" onclick="abrirEditarProducto('${product.codigo}')">
                            <i class="fas fa-edit mr-2"></i> Editar
                        </button>
                        <button class="px-4 py-2 rounded bg-red-500 text-white font-semibold" onclick="eliminarProducto('${product.codigo}')">
                            <i class="fas fa-trash mr-2"></i> Eliminar
                        </button>
                    </div>
                `;
                contenedor.appendChild(div);
            });
        }

        // Buscar productos en administración
        document.getElementById('busquedaAdmin').addEventListener('input', function() {
            const filtro = this.value.trim().toLowerCase();
            const productosFiltrados = products.filter(p =>
                p.codigo.toLowerCase().includes(filtro) ||
                p.descripcion.toLowerCase().includes(filtro)
            );
            renderAdminProductList(productosFiltrados);
        });

        // Abre el modal para editar un producto
        function abrirEditarProducto(codigo) {
            const product = products.find(p => p.codigo === codigo);
            if (!product) return;
            document.getElementById('editCodigo').value = product.codigo;
            document.getElementById('editDescripcion').value = product.descripcion;
            document.getElementById('editPrecioCosto').value = product.precioCosto;
            document.getElementById('editPrecioCliente').value = product.precioCliente;
            document.getElementById('editPiezas').value = product.piezas;
            document.getElementById('modalEditarProducto').classList.remove('hidden');

            // Guardar el código actual para actualizar
            document.getElementById('formEditarProducto').onsubmit = function(e) {
                e.preventDefault();
                actualizarProducto(product.codigo);
            };
        }

        // Cierra el modal de edición
        function cerrarModalEditarProducto() {
            document.getElementById('modalEditarProducto').classList.add('hidden');
        }

        // Actualiza el producto seleccionado (NO crea uno nuevo)
        function actualizarProducto(codigo) {
            const idx = products.findIndex(p => p.codigo === codigo);
            if (idx === -1) {
                alert('Producto no encontrado.');
                return;
            }
            products[idx].descripcion = document.getElementById('editDescripcion').value.trim();
            products[idx].precioCosto = parseFloat(document.getElementById('editPrecioCosto').value);
            products[idx].precioCliente = parseFloat(document.getElementById('editPrecioCliente').value);
            products[idx].piezas = parseInt(document.getElementById('editPiezas').value);
            localStorage.setItem('products', JSON.stringify(products));
            alert('Producto actualizado correctamente.');
            cerrarModalEditarProducto();
            renderAdminProductList(products);
            renderProductList && renderProductList();
        }

        // Elimina un producto
        function eliminarProducto(codigo) {
            if (!confirm('¿Seguro que deseas eliminar este producto?')) return;
            // Busca el índice del producto
            const idx = products.findIndex(p => p.codigo === codigo);
            if (idx !== -1) {
                products.splice(idx, 1); // Elimina el producto del arreglo
                localStorage.setItem('products', JSON.stringify(products)); // Actualiza el almacenamiento
                renderAdminProductList(products); // Refresca la lista de administración
                renderProductList && renderProductList(); // Refresca la lista principal si existe
                alert('Producto eliminado exitosamente');
                cerrarModalEditarProducto && cerrarModalEditarProducto(); // Cierra el modal si está abierto
            }
        }
    </script>
</body>
</html>
